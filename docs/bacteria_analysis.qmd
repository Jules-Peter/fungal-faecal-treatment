---
title: "bacterial_analysis"
format: html
editor: visual
author: "Jules Peter"
---

## Bacterial analysis experiment 1

This file is for analyzing bacteria change sin faeces due to fungal co-incubation

## Bacterial data analysis

loading packages and reading in data

```{r}
#| echo: false # Hide code
#| results: hide # Hide text output
#| include: false # Hide plots

library("tidyverse")
library("knitr")
library("rstatix")
library("broom")
library("flextable")
library("multcomp")
library("broom.mixed")
library("dplyr")
library("gt")

knitr::opts_knit$set(root.dir = ("../data"))
bacteria_analysis<-read.csv("../data/processed/bacteria_analysis.csv")
```

### Testing data for E. coli log change for normal distribution

```{r}
#| echo: false

###Testing data for normal distribution e_coli 
ecoli_log <- bacteria_analysis|>
  dplyr::select(species, log_change_ecoli)

shapiro_ecoli <- ecoli_log |>
  group_by(species)|>
  shapiro_test(log_change_ecoli)
print(shapiro_ecoli)

###qq-plot for each species 
ggplot(ecoli_log, aes(sample = `log_change_ecoli`)) +
  geom_qq() +
  facet_wrap(vars( species)) +
  geom_qq_line(color = "purple")

```

### Testing data of Enterococcus for normal distribution

```{r}
#| echo: false
###Testing data for normal distribution e_coli 
enterococcus_log <- bacteria_analysis|>
  dplyr::select(species, log_change_enterococcus)

shapiro_enterococcus <- enterococcus_log |>
  group_by(species)|>
  shapiro_test(log_change_enterococcus)
print(shapiro_enterococcus)

###qq-plot for each species 
ggplot(enterococcus_log, aes(sample = `log_change_enterococcus`)) +
  geom_qq() +
  facet_wrap(vars( species)) +
  geom_qq_line(color = "purple")
```

### Anova and Tukey test for ecoli

```{r}
#| echo: false


ecoli_anova <- ecoli_log |>
  anova_test(log_change_ecoli ~ species)  
ecoli_anova

```

### Tukey-Test E. coli

```{r}
#| echo: false

tukey_results <- ecoli_log |>
  tukey_hsd(log_change_ecoli ~ species)
tukey_results

ibrary(rstatix)
library(flextable)

# Add significance symbols/letters
tukey_results_formatted <- tukey_results |>
add_significance("p.adj") |>
  mutate(p.adj = scales::pvalue(p.adj))

```

tukey_results \<- ecoli_log \|\> tukey_hsd(log_change_ecoli \~ species) tukey_results

### Anova test for Enterococcus

```{r}
#| echo: false

enterococcus_anova <- enterococcus_log |>
  anova_test(log_change_enterococcus ~ species)  
enterococcus_anova

```

### Tukey test for Enterococcus

```{r}
#| echo: false

tukey_results <- enterococcus_log |>
  tukey_hsd(log_change_enterococcus ~ species)
tukey_results
```

## Showing significance in table

```{r}
#| echo: false
# Fit ANOVA model

enterococcus_anova<- aov(log_change_enterococcus ~ species, data = bacteria_analysis)

# Create APA-style table
tidy(enterococcus_anova) %>%
  flextable() %>%
  set_caption("ANOVA Results") %>%
  theme_apa() %>%  # Optional APA styling
  autofit() %>%
  print()  # Explicitly render the table

tukey_results <- TukeyHSD(enterococcus_anova)
print(tukey_results)
# Convert to clean table

# Display as formatted table


```

## box plots

```{r}
#| echo: false

bacteria_analysis$species <-factor(bacteria_analysis$species, levels=c("ctrl", "P. ostreatus", "C. comatus"))
  ggplot(bacteria_analysis,
       mapping=aes(x=species, y=log_change_ecoli))+
  labs(title = "Log change for E. coli",
       x = "Species",
       y = "Log change") +
  geom_boxplot()
  
  
  bacteria_analysis$species <-factor(bacteria_analysis$species, levels=c("ctrl", "P. ostreatus", "C. comatus"))
  ggplot(bacteria_analysis,
       mapping=aes(x=species, y=log_change_enterococcus))+
  labs(title = "Log change for Enterococcus",
       x = "Species",
       y = "Log change") +
  geom_boxplot()
  
##Both in one plot

log_change_both <- bacteria_analysis |>
  pivot_longer(
    cols = starts_with("log_change_"),  # Select both log-change columns
    names_to = "bacteria",              # New column for bacteria type
    values_to = "log_change"            # New column for log-change values
  )  
  
ggplot(log_change_both, aes(x = species, y = log_change, fill = bacteria)) +
  geom_boxplot(position = position_dodge(width = 0.8), alpha = 0.7) +
  labs(
    x = "Species",
    y = "Log Change",
    fill = "Bacteria Type",
    title = "Log Change Comparison by Species"
  ) +
  scale_fill_manual(
    values = c("log_change_ecoli" = "steelblue", "log_change_enterococcus" = "coral"),
    labels = c("E. coli", "Enterococcus")
  ) +
  theme_minimal()

ggplot(log_change_both, aes(x = species, y = log_change)) +
  geom_boxplot() +
  facet_wrap(~ bacteria, labeller = as_labeller(c(
    "log_change_ecoli" = "E. coli",
    "log_change_enterococcus" = "Enterococcus"
  )))
  
```

## 
